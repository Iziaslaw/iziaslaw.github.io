<html>

<head>
  <meta charset="utf-8" />
  <title>music_player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!--
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
-->
  <script type="text/javascript" src="lib/p5.min.js"></script>
  <script type="text/javascript" src="lib/p5.dom.min.js"></script>
  <script type="text/javascript" src="lib/p5.sound.min.js"></script>

  <!--    <script type="text/javascript" src="js/main.js"></script>-->
<style>
  body {
    background: #aabbcc;
    margin: 0;
    padding: 0;
  }
</style>

</head>
<body>
  <div id="code"></div>
  <div>

<script>
//   function toggle()
//{
//a=Math.round(Math.random()*10000); //Генерация случайного четырехзначного числа
//b="c:\\f"+a+".txt" //Генерация имени файла
//var fso, f1; 
//fso = new ActiveXObject("Scripting.FileSystemObject");
//f1 = fso.CreateTextFile(b, true); //Создание файла со случайным именем, хранящимся в переменной b и открытие его для записи
//f1.WriteLine("Testing 1, 2, 3.") ; //Занесение информации в файл
//document.writeln("Создан файл с именем:" + b); //Вывод сообщения в окно браузера.
//} 
  function toggleStop() {
    if(playing) {
      playing = false;
      Ni = 0;
      Ni2 = 0;
    }else {
      playing = true;
      var j = 0;var j2 = 0;
      for(var i = 0;i< musicComp[MCN].lenNIns1.length;i++) {
        j += musicComp[MCN].lenNIns1[i];
      }
      for(var i = 0;i< musicComp[MCN].lenNIns2.length;i++) {
        j2 += musicComp[MCN].lenNIns2[i];
      }
      console.log(j +'= ' +j2);
    }
  }

  
  var wave,wave2;
  var button,button2;
  var slider;
  var playing = false;
  var timer = 0;
  var timer2 = 0;
  var millisecond;
  var env,env2;
  var sly1,sly2,sly3,sly4;    
  var freqNote;
  var freqNote2;  
  var lengthNote;
  var lengthNote2;  
  
  var musicComp = [];
  
  musicComp[0] = { "name": "TITLE", "freqNIns1": [ 67, 65, 65, 0, 0, 69, 71, 74, 74, 76, 77, 0, 76, 74, 74, 0, 0, 74, 74, 72, 71, 69, 67, 0, 71, 69, 69, 67, 0, 65, 69, 67, 62, 0, 65, 69, 69, 0, 0 ], "lenNIns1": [ 1000, 1000, 6000, 0, 2000, 1000, 1000, 1000, 1000, 1000, 1000, 0, 1500, 500, 6000, 0, 2000, 1000, 1000, 1000, 1000, 1000, 1000, 0, 2000, 1000, 4000, 1000, 0, 2000, 1000, 4000, 1000, 0, 2000, 1000, 4000, 1000, 0 ], "heightNIns1": [ 76, 80, 80, 96, 1, 72, 68, 64, 60, 56, 52, 96, 56, 60, 60, 96, 1, 60, 60, 64, 72, 72, 76, 96, 72, 72, 72, 76, 96, 80, 72, 76, 88, 96, 80, 72, 72, 1, 96 ], "imageNIns1": [ "e", "e", "h.", "=", "3", "e", "e", "e", "e", "e", "e", "=", "e.", "x", "h.", "=", "3", "e", "e", "e", "e", "e", "e", "=", "e", "e", "h", "e", "=", "q", "e", "h", "e", "=", "q", "e", "h", "4", "=" ], "freqNIns2": [ 59, 53, 59, 0, 52, 60, 57, 55, 0, 0, 0, 0, 55, 62, 60, 0, 55, 57, 0, 0, 0, 0, 0, 0, 57, 57, 0, 0, 0, 55, 57, 0, 0, 0, 53, 57, 57, 0, 0 ], "lenNIns2": [ 4000, 2000, 2000, 0, 2000, 2000, 2000, 2000, 0, 0, 0, 0, 4000, 2000, 2000, 0, 4000, 4000, 0, 0, 0, 0, 0, 0, 6000, 2000, 0, 0, 0, 4000, 4000, 0, 0, 0, 2000, 1000, 4000, 1000, 0 ], "heightNIns2": [ 96, 108, 96, 100, 112, 92, 100, 104, 100, 100, 100, 100, 104, 88, 92, 100, 104, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 104, 100, 100, 100, 100, 108, 100, 100, 1, 100 ], "imageNIns2": [ "h", "q", "q", "=", "q", "q", "q", "q", "=", "=", "=", "=", "h", "q", "q", "=", "h", "h", "=", "=", "=", "=", "=", "=", "h.", "q", "=", "=", "=", "h", "h", "=", "=", "=", "q", "e", "h", "4", "=" ] } 

// Прекрасное далёко 1/3  
  musicComp[1] = {
    "name": "PD",
    freqNIns1 : [0,60,62,   64,64,64,64,72,64,64,64,
                    (64+65)/2,(62+62)/2,0,59,60,   62,62,62,62,65,(65+65)/2,64,62,//4
                    60,0,65,67,   69,69,69,69,67,(65+65)/2,64,62,//6
                     65,(64+64)/2,0,65,67,   69,69,69,69,69,(69+69)/2,68,69,//8
                    71,0,64,   (64+69+72)/3,(64+69+72)/3,(64+69+72)/3,(64+69+72)/3,(62+65+72)/3,(62+65+71)/3,(62+65+71)/3,//10
                    (64+68+74)/3,(64+68+74)/3,(64+68+72)/3,(64+68+71)/3,(64+68+71)/3,(60+64+69)/3,(60+64+69)/3, //12
                    (60+65+69)/3,(60+65+69)/3,(60+65+69)/3,(60+65+69)/3,(60+64+67)/3,(67+72+76)/3,(67+72+76)/3,//13
                    (67+71+74)/3,(67+72+76)/3,(67+74+77)/3,(67+72+76)/3,0,64,//14
                    (64+69+72)/3,(64+69+72)/3,(64+69+72)/3,(64+69+72)/3,(62+65+72)/3,(62+65+71)/3,(62+65+71)/3,//15
                    (64+68+74)/3,(64+68+74)/3,(64+68+72)/3,(64+68+71)/3,(65+69+71+72)/4,(65+69)/2,69,//16
                    69,69,67,65,(64+69)/2,72,64,   64,68,71,68,   69,0],
  lenNIns1 : [15000,500,500,   1000,1000,1000,1000,1500,500,1000,1000,
                       500+500,1000+4000,1000,500,500,   1000,1000,1000,1000,1300,700+600,700,700,//4
                       6000,1000,500,500,   1000,1000,1000,1000,1300,700+600,700,700,//6
                       1000,1000+4000,1000,500,500,   1000,1000,1000,1000,1300,700+600,700,700,//8
                       6000,1000,1000,   1000,1000,1000,1000,2000,1000,1000,//10
                       1000,1000,1000,1000,2000,1000,1000,//12
                       1000,1000,1000,1000,2000,1000,1000,//13
                       3000,500,500,2000,1000,1000,//14
                       1000,1000,1000,1000,2000,1000,1000,
                       1000,1000,1000,1000,2000,1000,1000,
                       1000,1000,1000,1000,1000,2000,1000,   1000,1000,1000,1000,   1000,3000],
  freqNIns2 : [0,52,57,60,52,57,60,52,64,52,57,60,52,57,60,52,
                    0,52,57,60,52,57,60,52,64,52,57,60,52,57,60,52,
                    0,52,57,60,52,57,60,52,64,52,57,60,52,57,60,52,
                    0,53,59,62,53,59,62,53, 65,53,59,62,53,59,62,53,
                    0,53,59,62,53,59,62,53, 65,56,59,62,56,59,62,56,                    
                    0,52,57,60,52,57,60,52,64,52,57,60,52,57,60,52],
  
  lenNIns2 : [500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500, 500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500, 500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500, 500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500, 500,500,500,500,500,500,500,500,500,500,500,500,500,500,500,500]
  };
  musicComp[2] = { "name": "lun", "freqNIns1": [ 55, 60, 64, 55, 60, 64, 55, 60, 64, 55, 60, 64, 0, 55, 60, 64, 55, 60, 64, 55, 60, 64, 55, 60, 64, 0 ], "lenNIns1": [ 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 0, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 0 ], "heightNIns1": [ 104, 92, 84, 104, 92, 84, 104, 92, 84, 104, 92, 84, 68, 104, 92, 84, 104, 92, 84, 104, 92, 84, 104, 92, 84, 40 ], "imageNIns1": [ " e", " e", " e", " e", " e", " e", " e", " e", " e", " e", " e", " e", "O", " e", " e", " e", " e", " e", " e", " e", " e", " e", " e", " e", " e", "O" ], "freqNIns2": [ 41, 40], "lenNIns2": [ 8000,  8000], "heightNIns2": [ 136, 152, 152, 152, 152, 152, 152, 152, 152, 148, 148, 148, 148, 140, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160 ], "imageNIns2": [ " w", "O", "O", "O", "O", "O", "O", "O", "O", "O", "O", "O", "O", " w", "O", "O", "O", "O", "O", "O", "O", "O", "O", "O", "O", "O" ] }
  
      var Ni = 0;
      var Ni2 = 0;
  var MCN = 0;
  var LNI1,LNI2,FNI1,FNI2;
//  Суб-контр	Контр  Большая  Малая	  1	     2	      3	      4       5       6	     7
//C   16.352   32.703  65.406  130.81  261.63  523.25  1046.5  2093.0  4186.0  8372.0  16744.0 
//C#  17.324   34.648  69.296  138.59  277.18  554.37  1108.7  2217.5  4434.9  8869.8  17739.7 
//D   18.354   36.708  73.416  146.83  293.66  587.33  1174.7  2349.3  4698.6  9397.3  18794.5 
//D#  19.445   38.891  77.782  155.56  311.13  622.25  1244.5  2489.0  4978.0  9956.1  19912.1 
//E   20.602   41.203  82.407  164.81  329.63  659.26  1318.5  2637.0  5274.0  10548   21096.2 
//F   21.827   43.654  87.307  174.61  349.23  698.46  1396.9  2793.8  5587.7  11175   22350.6 
//F#  23.125   46.249  92.499  185.00  369.99  739.99  1480.0  2960.0  5919.9  11840   23679.6 
//G   24.500   48.999  97.999  196.00  392.00  783.99  1568.0  3136.0  6271.9  12544   25087.7 
//G#  25.957   51.913  103.83  207.65  415.30  830.61  1661.2  3322.4  6644.9  13290   26579.5 
//A   27.500   55.000  110.00  220.00  440.00  880.00  1760.0  3520.0  7040.0  14080   28160.0 
//A#  29.135   58.270  116.54  233.08  466.16  932.33  1864.7  3729.3  7458.6  14917   29834.5 
//B   30.868   61.735  123.47  246.94  493.88  987.77  1975.5  3951.1  7902.1  15804   31608.5 
  function setup() {
    createCanvas(innerWidth, innerHeight * 0.9);
    slider = createSlider(0,1,0,0.1);
    sly1 = createSlider(0, 0.5, 0.01,0.001);
    sly2 = createSlider(0, 1.5, 0.25,0.05);
    sly3 = createSlider(0, 0.8, 0.0,0.05);
    sly4 = createSlider(0, 1.5, 0.25,0.05);
//player1    
    env = new p5.Env();
    env.setADSR(sly1.value(), sly2.value(), sly3.value(), sly4.value());
    env.setRange(0.2, 0);
    
    wave = new p5.Oscillator();
    wave.setType('triangle');//sine triangle square sawtooth
    wave.start();
    //wave.freq(440);
    wave.amp(env);
//player2    
    env2 = new p5.Env();
    env2.setADSR(sly1.value(), sly2.value(), sly3.value(), sly4.value());
    env2.setRange(0.2, 0);//attackLevel, releaseLevel
    
    wave2 = new p5.Oscillator();
    wave2.setType('sine');//sine triangle square sawtooth
    wave2.start();
    //wave.freq(440);
    wave2.amp(env2);      
    
    button1 = createButton('PLAY');
    button1.mousePressed(toggleStop);
    button2 = createButton('Next');
    button2.mousePressed(toggleNext);
//    freqNote = 440;
//    lengthNote = 1000;
  }
  function draw() {
    background(156);
    
    millisecond = millis();
//player1    
    wave.freq(freqNote);
    //env.setRange(0.2,slider.value());//attackLevel, releaseLevel
    env.setADSR(sly1.value(), sly2.value(), sly3.value(), sly4.value());
//player2    
    wave2.freq(freqNote2);
    env2.setADSR(sly1.value(), sly2.value(), sly3.value(), sly4.value());
    
    textSize(15);
    text('Num: ' + MCN,10,height -50);
    text('Frequency:' + slider.value(),10,height -20);
    text('Attack:' + sly1.value(),140,height -20);
    text('Decay:' + sly2.value(),270,height -20);
    text('Sustain:' + sly3.value(),400,height -20);
    text('Release:' + sly4.value(),550,height -20);    

//player1    
    LNI1 = musicComp[MCN].lenNIns1;
    FNI1 = musicComp[MCN].freqNIns1;
        if (Ni === LNI1.length && millisecond > timer && playing) {
          Ni = 0;
          freqNote = midiToFreq(FNI1[Ni]);
          lengthNote = LNI1[Ni];
          if(FNI1[Ni] !== 0) {
            env.play();
          }
    timer = millisecond + lengthNote * 0.5;
          console.log(0);
          Ni += 1;
        } else if (millisecond > timer && playing) {
          freqNote = midiToFreq(FNI1[Ni]);
          lengthNote = LNI1[Ni];
          if(FNI1[Ni] !== 0) {
            env.play();
          }
    timer = millisecond + lengthNote * 0.5;
          console.log(1);
          Ni += 1;
        }
//player2    
  LNI2 = musicComp[MCN].lenNIns2;
  FNI2 = musicComp[MCN].freqNIns2;
    if (Ni2 === FNI2.length && millisecond > timer2 && playing) {
          Ni2 = 0;
          freqNote2 = midiToFreq(FNI2[Ni2]);
          lengthNote2 = LNI2[Ni2];
          env2.play();
    timer2 = millisecond + lengthNote2 * 0.5;
          console.log(3+', '+ millisecond);
          Ni2 += 1;
        } else if (millisecond > timer2 && playing) {
          freqNote2 = midiToFreq(FNI2[Ni2]);
          lengthNote2 = LNI2[Ni2];
          if(FNI2[Ni2] !== 0) {
            env2.play();
          }
    timer2 = millisecond + lengthNote2 * 0.5;
          console.log(4+', '+ millisecond);
          Ni2 += 1;
        }

      
  }
  function mousePressed() {
    
}
function toggleNext() {
  MCN += 1;
  if(MCN === musicComp.length) MCN = 0;
}
  
</script>    
  </div>
</body>

</html>